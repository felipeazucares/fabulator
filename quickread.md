# Fabulator Quick Read - Tree Model & CRUD Guide

## The Core Concept

Fabulator is a **stateless tree editor**. There is no in-memory tree living between requests. Every API call that touches tree data follows the same cycle:

```
MongoDB (latest save) -> load into treelib.Tree -> modify in memory -> save as NEW document -> respond
```

This means the `tree_collection` in MongoDB is **append-only** -- every write operation (create node, update node, delete node, prune, graft) inserts a brand new save document. Nothing is updated in place.

## The Data Model

```
MongoDB Document (tree_collection)
+-- _id            (ObjectId -- the "save_id")
+-- account_id     (bcrypt hash of username -- ties user to their trees)
+-- date_time      (UTC timestamp -- used to find "latest")
+-- tree           (serialized treelib.Tree dict)
    +-- _identifier   (tree's own UUID)
    +-- root          (node_id of root node)
    +-- _nodes        (dict of node_id -> node)
         +-- each node:
              +-- _tag          (display name, e.g. "Chapter 1")
              +-- _identifier   (UUID, auto-generated by treelib)
              +-- _predecessor  (parent pointer)
              +-- _successors   (children list)
              +-- data          (NodePayload)
                   +-- description  ("John meets his evil twin")
                   +-- text         (the actual narrative content)
                   +-- previous     (node_id -- linked-list hint for ordering)
                   +-- next         (node_id -- linked-list hint for ordering)
                   +-- tags         (["main plot", "john"])
```

## Node CRUD

| Op | Endpoint | What happens |
|----|----------|-------------|
| **Create** | `POST /nodes/{name}` | If no `parent` in body -> creates **root** (fails if root exists). If `parent` provided -> creates child. Saves new snapshot. |
| **Read one** | `GET /nodes/{id}` | Loads latest tree, returns the node. |
| **Read all** | `GET /nodes?filterval=tag` | Loads latest tree, returns all nodes (optionally filtered by tag). |
| **Update** | `PUT /nodes/{id}` | Updates name, payload, and/or parent (**reparenting is supported**). Saves new snapshot. |
| **Delete** | `DELETE /nodes/{id}` | Removes node **and all its children**. Saves new snapshot. |

## Tree Operations

| Endpoint | What it actually does |
|----------|----------------------|
| `GET /trees/root` | Returns the root node's ID (read-only). |
| `GET /trees/{id}` | **Prune** -- removes the subtree rooted at `{id}` and returns it. Destructive despite being GET. |
| `POST /trees/{id}` | **Graft** -- takes a serialized subtree in the body and pastes it under node `{id}`. |

## Save/Load System

| Endpoint | Purpose |
|----------|---------|
| `GET /saves` | List all save documents (metadata) for your account. |
| `GET /loads` | Load the **latest** save as a tree. |
| `GET /loads/{save_id}` | Load a **specific** historical save (with ownership check). |
| `DELETE /saves` | Delete **all** saves for your account. |

There is no explicit "save" endpoint -- saves happen implicitly on every write operation.

## How Reconstruction Works

When a tree is loaded from MongoDB, `build_tree_from_dict()` (`database.py:220`) walks the serialized dict recursively:

1. Find the `root` node ID
2. Create a new `treelib.Tree` with the stored `_identifier`
3. `add_a_node()` recurses depth-first: reads `_tag`, `_identifier`, `data`, and `_successors` from the dict, creates each node in the new tree, then recurses into children

## Key Things to Remember

- **`account_id`** is the universal tenant key -- it's a bcrypt hash of the username, set at registration, and used to partition all data
- **Every write = new save** -- there's no update-in-place, so the saves collection grows linearly with edits
- **`previous`/`next`** on NodePayload are **not used by treelib** -- they're application-level hints for sibling ordering within the narrative (treelib doesn't have sibling order)
- **No depth limit** on tree recursion during reconstruction
- The `GET /trees/{id}` prune endpoint is a mutating GET (known quirk)
